name: Build gpg-winhello

on:
  push:
    branches:
      - main
    paths:
      - "*.cs"
      - "*.csproj"
      - "nix/**"
      - ".github/workflows/gpg-winhello.yml"
    tags:
      - "v*"
  pull_request:
    paths:
      - "*.cs"
      - "*.csproj"
      - "nix/**"
      - ".github/workflows/gpg-winhello.yml"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Build gpg-winhello
        run: nix build -L

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: Prepare artifact
        run: |
          mkdir -p dist
          cp result/lib/gpg-winhello/gpg-winhello.exe dist/
          cd dist
          sha256sum gpg-winhello.exe > gpg-winhello.exe.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gpg-winhello-${{ steps.version.outputs.version }}
          path: dist/*

      - name: Create release
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          gh release create ${{ github.ref_name }} \
            dist/* \
            --title "GPG Windows Hello ${{ steps.version.outputs.version }}" \
            --notes "# GPG Windows Hello ${{ steps.version.outputs.version }}

          Use Windows Hello fingerprint authentication to unlock GPG SSH agent.

          ## Installation

          1. Download \`gpg-winhello.exe\`
          2. Run \`gpg-winhello.exe setup\` to configure Windows Hello encryption
          3. Configure GPG agent to use this as pinentry program

          See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for full instructions.

          ## Verification

          \`\`\`powershell
          # Verify SHA256 hash
          Get-FileHash gpg-winhello.exe -Algorithm SHA256
          \`\`\`"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
